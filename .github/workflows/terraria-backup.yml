name: Terraria world backup (FreeGameHost.xyz)  
  
on:  
  schedule:  
    - cron: '*/15 * * * *'  
  workflow_dispatch:  
  
jobs:  
  backup:  
    runs-on: ubuntu-latest  
  
    steps:  
      - name: Install dependencies  
        run: |  
          sudo apt-get update -y  
          sudo apt-get install -y sshpass jq  
          curl -fsSL https://rclone.org/install.sh | sudo bash  
  
      - name: Decode rclone config  
        env:  
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF }}  
        run: |  
          set -euo pipefail  
          if [ -z "${RCLONE_CONF_B64:-}" ]; then  
            echo "❌ RCLONE_CONF secret missing"  
            exit 1  
          fi  
          echo "$RCLONE_CONF_B64" | base64 -d > "$GITHUB_WORKSPACE/rclone.conf"  
          chmod 600 "$GITHUB_WORKSPACE/rclone.conf"  
          echo "✔️ rclone.conf written"  
  
      - name: Trigger server save (optional; won't fail job)  
        env:  
          PANEL_URL: ${{ secrets.PANEL_URL }}  
          PANEL_API_KEY: ${{ secrets.PANEL_API_KEY }}  
          SERVER_ID: ${{ secrets.SERVER_ID }}  
          SKIP_SAVE: ${{ secrets.SKIP_SAVE }}  
        run: |  
          set -euo pipefail || true  
          if [ "${SKIP_SAVE:-}" = "true" ]; then  
            echo "SKIP_SAVE=true → skipping panel save"  
          elif [ -z "${PANEL_URL:-}" ] || [ -z "${PANEL_API_KEY:-}" ] || [ -z "${SERVER_ID:-}" ]; then  
            echo "Panel secrets not fully set → skipping save"  
          else  
            HTTP_CODE=$(curl -s -o panel_response.json -w "%{http_code}" \  
              -X POST "$PANEL_URL/api/client/servers/$SERVER_ID/command" \  
              -H "Authorization: Bearer $PANEL_API_KEY" \  
              -H "Accept: application/vnd.pterodactyl.v1+json" \  
              -H "Content-Type: application/json" \  
              -d '{"command":"save"}' || true)  
            echo "HTTP code: $HTTP_CODE"  
            echo "Panel response:"  
            cat panel_response.json || true  
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then  
              echo "Save command accepted"  
            else  
              echo "Save returned $HTTP_CODE — continuing to SFTP copy"  
            fi  
            sleep 8  
          fi  
  
      - name: Direct copy SFTP -> Google Drive via rclone (auto-detect path, verbose)  
        env:  
          SFTP_HOST: ${{ secrets.TERRARIA_SFTP_HOST }}  
          SFTP_PORT: ${{ secrets.TERRARIA_SFTP_PORT }}  
          SFTP_USER: ${{ secrets.TERRARIA_SFTP_USER }}  
          SFTP_PASS: ${{ secrets.TERRARIA_SFTP_PASS }}  
          SFTP_KEY: ${{ secrets.TERRARIA_SFTP_KEY }}  
          REMOTE_WORLD_PATH: ${{ secrets.TERRARIA_WORLD_PATH }}  
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}  
          SERVER_ID: ${{ secrets.SERVER_ID }}  
        run: |  
          set -euo pipefail  
  
          # basic checks  
          if [ -z "${SFTP_HOST:-}" ] || [ -z "${SFTP_USER:-}" ]; then  
            echo "❌ SFTP_HOST / SFTP_USER are required"  
            exit 1  
          fi  
          if [ -z "${RCLONE_REMOTE_NAME:-}" ] || [ -z "${SERVER_ID:-}" ]; then  
            echo "❌ RCLONE_REMOTE_NAME and SERVER_ID are required"  
            exit 1  
          fi  
  
          echo "SFTP auth options present? (lengths will be shown, values are not revealed)"  
          if [ -n "${SFTP_PASS:-}" ]; then  
            echo "SFTP_PASS length: ${#SFTP_PASS}"  
          else  
            echo "SFTP_PASS not set"  
          fi  
          if [ -n "${SFTP_KEY:-}" ]; then  
            echo "SFTP_KEY length: ${#SFTP_KEY}"  
          else  
            echo "SFTP_KEY not set"  
          fi  
  
          echo "Appending temporary sftp remote (sftp_tmp) to rclone.conf"  
          printf "\n" >> "$GITHUB_WORKSPACE/rclone.conf"  
          printf "[sftp_tmp]\n" >> "$GITHUB_WORKSPACE/rclone.conf"  
          printf "type = sftp\n" >> "$GITHUB_WORKSPACE/rclone.conf"  
          printf "host = %s\n" "$SFTP_HOST" >> "$GITHUB_WORKSPACE/rclone.conf"  
          printf "user = %s\n" "$SFTP_USER" >> "$GITHUB_WORKSPACE/rclone.conf"  
          printf "port = %s\n" "${SFTP_PORT:-22}" >> "$GITHUB_WORKSPACE/rclone.conf"  
  
          if [ -n "${SFTP_KEY:-}" ]; then  
            echo "Using SSH private key auth (from secret TERRARIA_SFTP_KEY)"  
            printf "%s\n" "$SFTP_KEY" > "$GITHUB_WORKSPACE/sftp_key.pem"  
            chmod 600 "$GITHUB_WORKSPACE/sftp_key.pem"  
            printf "key_file = %s\n" "$GITHUB_WORKSPACE/sftp_key.pem" >> "$GITHUB_WORKSPACE/rclone.conf"  
          elif [ -n "${SFTP_PASS:-}" ]; then  
            echo "Using password auth (from secret TERRARIA_SFTP_PASS)"  
            printf "pass = %s\n" "$SFTP_PASS" >> "$GITHUB_WORKSPACE/rclone.conf"  
          else  
            echo "❌ No SFTP auth provided (set TERRARIA_SFTP_PASS or TERRARIA_SFTP_KEY secret)"  
            exit 1  
          fi  
  
          # candidate paths — расширенный набор  
          CANDIDATES=(  
            "${REMOTE_WORLD_PATH:-}"  
            "/home/container/saves/Worlds"  
            "/home/container/saves"  
            "/home/container"  
            "container/saves/Worlds"  
            "container/saves"  
            "saves/Worlds"  
            "saves"  
            "Worlds"  
            "world"  
            "/home/jeremih333.27c01087/Worlds"  
            "/home/jeremih333.27c01087"  
            "/home"  
            ""  
          )  
  
          echo "DEBUG: root listing (what SFTP sees as root)"  
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsf "sftp_tmp:" || true  
  
          FOUND=""  
          for p in "${CANDIDATES[@]}"; do  
            if [ -z "$p" ]; then  
              TRY=":"  
            else  
              TRY="$p"  
            fi  
            echo "Trying candidate path: '$p'"  
            COUNT=$(rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsf "sftp_tmp:${TRY}" --include "*.wld" --include "*.wld.bak" 2>/dev/null | sed '/^\s*$/d' | wc -l || true)  
            echo " -> matches: $COUNT"  
            if [ "${COUNT:-0}" -gt 0 ]; then  
              FOUND="$TRY"  
              break  
            fi  
          done  
  
          if [ -z "$FOUND" ]; then  
            echo "No candidate matched — performing recursive search (this may take a little while)..."  
            FIRST_WLD_PATH=$(rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsjson "sftp_tmp:" --recursive --files-only 2>/dev/null \  
              | jq -r '.[] | select(.Path | test("\\.wld$")) | .Path' | head -n1 || true)  
            if [ -n "$FIRST_WLD_PATH" ]; then  
              echo "Found a .wld at: $FIRST_WLD_PATH"  
              FOUND="$(dirname "$FIRST_WLD_PATH")"  
            else  
              echo "No .wld files found anywhere on sftp_tmp:"  
              exit 1  
            fi  
          fi  
  
          echo "Using found remote path: '$FOUND'"  
  
          COUNT_FINAL=$(rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsf "sftp_tmp:${FOUND}" --include "*.wld" --include "*.wld.bak" 2>/dev/null | sed '/^\s*$/d' | wc -l || true)  
          echo "Found $COUNT_FINAL .wld/.wld.bak files in $FOUND"  
  
          if [ "${COUNT_FINAL:-0}" -eq 0 ]; then  
            echo "No world files to copy; aborting"  
            exit 1  
          fi  
  
          ARCHIVE="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive/$(date +%F_%H-%M-%S)"  
          LATEST="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/latest"  
  
          echo "Copying $FOUND -> $ARCHIVE"  
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" copy "sftp_tmp:${FOUND}" "$ARCHIVE" --include "*.wld" --include "*.wld.bak" --create-empty-src-dirs --transfers=4 --checkers=8 --progress  
  
          echo "Syncing latest -> $LATEST"  
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" sync "sftp_tmp:${FOUND}" "$LATEST" --include "*.wld" --include "*.wld.bak" --create-empty-src-dirs --progress  
  
      - name: Prune old backups (optional)  
        env:  
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}  
          SERVER_ID: ${{ secrets.SERVER_ID }}  
        run: |  
          set -e || true  
          KEEP_DAYS=30  
          ARCHIVE_DIR="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive"  
          echo "Pruning backups older than $KEEP_DAYS days in $ARCHIVE_DIR"  
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" delete "$ARCHIVE_DIR" --min-age ${KEEP_DAYS}d || true  
          echo "Prune done"
