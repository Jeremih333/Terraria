name: Terraria world backup (FreeGameHost.xyz)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch: {}

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass jq
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Decode rclone config
        env:
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF }}
        run: |
          set -euo pipefail
          if [ -z "${RCLONE_CONF_B64:-}" ]; then
            echo "❌ RCLONE_CONF secret missing"
            exit 1
          fi
          echo "$RCLONE_CONF_B64" | base64 -d > "$GITHUB_WORKSPACE/rclone.conf"
          chmod 600 "$GITHUB_WORKSPACE/rclone.conf"
          echo "✔️ rclone.conf ready"

      - name: (Optional) Trigger server save
        env:
          PANEL_URL: ${{ secrets.PANEL_URL }}
          PANEL_API_KEY: ${{ secrets.PANEL_API_KEY }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
          SKIP_SAVE: ${{ secrets.SKIP_SAVE }}
        run: |
          set -euo pipefail || true
          if [ "${SKIP_SAVE:-}" = "true" ]; then
            echo "SKIP_SAVE=true → skipping panel save"
          elif [ -n "${PANEL_URL:-}" ] && [ -n "${PANEL_API_KEY:-}" ] && [ -n "${SERVER_ID:-}" ]; then
            echo "Issuing save command to panel (best-effort)..."
            HTTP_CODE=$(curl -s -o panel_response.json -w "%{http_code}" \
              -X POST "$PANEL_URL/api/client/servers/$SERVER_ID/command" \
              -H "Authorization: Bearer $PANEL_API_KEY" \
              -H "Accept: application/vnd.pterodactyl.v1+json" \
              -H "Content-Type: application/json" \
              -d '{"command":"save"}' || true)
            echo "Panel HTTP code: $HTTP_CODE"
            cat panel_response.json || true
            sleep 8
          else
            echo "Panel API not configured → skipping save"
          fi

      - name: SFTP copy: detect path & upload to Google Drive
        id: sftp_upload
        env:
          SFTP_HOST: ${{ secrets.TERRARIA_SFTP_HOST }}
          SFTP_PORT: ${{ secrets.TERRARIA_SFTP_PORT }}
          SFTP_USER: ${{ secrets.TERRARIA_SFTP_USER }}
          SFTP_PASS: ${{ secrets.TERRARIA_SFTP_PASS }}
          SFTP_KEY: ${{ secrets.TERRARIA_SFTP_KEY }}
          REMOTE_WORLD_PATH: ${{ secrets.TERRARIA_WORLD_PATH }}
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -euo pipefail

          # Basic validation
          if [ -z "${SFTP_HOST:-}" ] || [ -z "${SFTP_USER:-}" ]; then
            echo "❌ SFTP_HOST and SFTP_USER must be set in secrets"
            exit 1
          fi
          if [ -z "${RCLONE_REMOTE_NAME:-}" ] || [ -z "${SERVER_ID:-}" ]; then
            echo "❌ RCLONE_REMOTE_NAME and SERVER_ID must be set in secrets"
            exit 1
          fi

          # Show whether auth options are present (lengths only)
          echo "SFTP auth options present? (lengths only)"
          if [ -n "${SFTP_PASS:-}" ]; then
            echo "SFTP_PASS length: ${#SFTP_PASS}"
          else
            echo "SFTP_PASS not set"
          fi
          if [ -n "${SFTP_KEY:-}" ]; then
            echo "SFTP_KEY length: ${#SFTP_KEY}"
          else
            echo "SFTP_KEY not set"
          fi

          # If key provided, write to file (but prefer password if provided)
          TMP_KEY_FILE=""
          if [ -n "${SFTP_KEY:-}" ]; then
            TMP_KEY_FILE="$GITHUB_WORKSPACE/sftp_key.pem"
            printf "%s\n" "$SFTP_KEY" > "$TMP_KEY_FILE"
            chmod 600 "$TMP_KEY_FILE"
          fi

          # Create temporary remote using rclone config create to avoid obfuscated-password issues
          # Remove any prior sftp_tmp if exists (ignore errors)
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" config delete sftp_tmp >/dev/null 2>&1 || true

          if [ -n "${SFTP_KEY:-}" ] && [ -z "${SFTP_PASS:-}" ]; then
            echo "Creating rclone remote sftp_tmp using key_file auth"
            # key_file parameter name for rclone config is 'key_file'
            rclone --config="$GITHUB_WORKSPACE/rclone.conf" config create sftp_tmp sftp \
              host "$SFTP_HOST" user "$SFTP_USER" port "${SFTP_PORT:-22}" key_file "$TMP_KEY_FILE"
          elif [ -n "${SFTP_PASS:-}" ]; then
            echo "Creating rclone remote sftp_tmp using password auth"
            # pass is provided as an argument (rclone will store it correctly)
            rclone --config="$GITHUB_WORKSPACE/rclone.conf" config create sftp_tmp sftp \
              host "$SFTP_HOST" user "$SFTP_USER" port "${SFTP_PORT:-22}" pass "$SFTP_PASS"
          else
            echo "❌ No SFTP auth provided (provide TERRARIA_SFTP_PASS or TERRARIA_SFTP_KEY)"
            exit 1
          fi

          # Test connection to sftp_tmp root quietly (do not expose secrets)
          echo "DEBUG: testing sftp_tmp root access (quiet)"
          if ! rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsf "sftp_tmp:" >/dev/null 2>&1; then
            echo "ERROR: Failed to list sftp_tmp: — connection/auth may be invalid"
            # show a small diagnostic (without printing secrets)
            rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsd "sftp_tmp:" || true
            # cleanup
            rclone --config="$GITHUB_WORKSPACE/rclone.conf" config delete sftp_tmp >/dev/null 2>&1 || true
            exit 1
          fi
          echo "✔️ sftp_tmp reachable"

          # Candidate paths to try (REMOTE_WORLD_PATH first, if set)
          CANDIDATES=(
            "${REMOTE_WORLD_PATH:-}"
            "saves/Worlds"
            "saves"
            "Worlds"
            "world"
            "/home/container/saves/Worlds"
            "/home/container/saves"
            "/home/container"
            "/home/${SFTP_USER}"
            "/home"
            ""
          )

          FOUND=""
          echo "Trying candidate paths for world files..."
          for p in "${CANDIDATES[@]}"; do
            if [ -z "$p" ]; then
              TARGET="sftp_tmp:"
              DISPLAY="(root)"
            else
              TARGET="sftp_tmp:${p}"
              DISPLAY="$p"
            fi
            echo " - trying: $DISPLAY"
            # list only names matching .wld/.wld.bak; suppress errors
            MATCHES=$(rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsf "$TARGET" --include "*.wld" --include "*.wld.bak" 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
              FOUND="$p"
              echo " → matches found in: $DISPLAY"
              break
            else
              echo " → no matches"
            fi
          done

          # If not found, do a controlled recursive search (lsjson + jq) on root (may be slower)
          if [ -z "$FOUND" ]; then
            echo "No candidate path matched — starting recursive search (this may take a while)..."
            FIRST=$(rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsjson "sftp_tmp:" --recursive --files-only 2>/dev/null \
              | jq -r '.[] | select(.Path | test("\\.wld$")) | .Path' | head -n1 || true)
            if [ -n "$FIRST" ]; then
              echo "Found .wld at path: $FIRST"
              FOUND="$(dirname "$FIRST")"
              echo "Using parent dir: $FOUND"
            else
              echo "❌ No .wld files found on sftp_tmp:"
              # cleanup remote
              rclone --config="$GITHUB_WORKSPACE/rclone.conf" config delete sftp_tmp >/dev/null 2>&1 || true
              exit 1
            fi
          fi

          # If FOUND is empty string (root), set target accordingly
          if [ -z "$FOUND" ]; then
            SELECTED_TARGET="sftp_tmp:"
            SELECTED_PATH="(root)"
          else
            SELECTED_TARGET="sftp_tmp:${FOUND}"
            SELECTED_PATH="$FOUND"
          fi

          echo "Using remote path: $SELECTED_PATH"

          # Count final
          FINAL_COUNT=$(rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsf "$SELECTED_TARGET" --include "*.wld" --include "*.wld.bak" 2>/dev/null | sed '/^\s*$/d' | wc -l || true)
          echo "Files to back up: $FINAL_COUNT"

          if [ "${FINAL_COUNT:-0}" -eq 0 ]; then
            echo "No .wld/.wld.bak files to upload — aborting"
            rclone --config="$GITHUB_WORKSPACE/rclone.conf" config delete sftp_tmp >/dev/null 2>&1 || true
            exit 1
          fi

          # Prepare destinations
          ARCHIVE="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive/$(date +%F_%H-%M-%S)"
          LATEST="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/latest"

          echo "Uploading to archive: $ARCHIVE"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" copy "$SELECTED_TARGET" "$ARCHIVE" \
            --include "*.wld" --include "*.wld.bak" --create-empty-src-dirs --transfers=4 --checkers=8 --progress

          echo "Updating latest -> $LATEST"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" sync "$SELECTED_TARGET" "$LATEST" \
            --include "*.wld" --include "*.wld.bak" --create-empty-src-dirs --progress

          # Cleanup temporary sftp remote
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" config delete sftp_tmp >/dev/null 2>&1 || true

          echo "✔️ Upload complete"

      - name: Prune old backups (optional)
        env:
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -e || true
          KEEP_DAYS=30
          ARCHIVE_DIR="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive"
          echo "Pruning backups older than $KEEP_DAYS days in $ARCHIVE_DIR"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" delete "$ARCHIVE_DIR" --min-age ${KEEP_DAYS}d || true
          echo "✔️ Prune done"
