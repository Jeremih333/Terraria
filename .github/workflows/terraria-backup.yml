name: Terraria world backup (FreeGameHost.xyz)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    outputs:
      files: ${{ steps.run_backup.outputs.files }}
      path: ${{ steps.run_backup.outputs.path }}

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl sed coreutils
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Decode rclone config
        env:
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF }}
        run: |
          set -e
          if [ -z "${RCLONE_CONF_B64}" ]; then
            echo "RCLONE_CONF secret missing"
            exit 1
          fi
          echo "$RCLONE_CONF_B64" | base64 -d > rclone.conf
          chmod 600 rclone.conf
          echo "rclone.conf ready"

      - name: Run backup (detect path, upload)
        id: run_backup
        env:
          SFTP_HOST: ${{ secrets.TERRARIA_SFTP_HOST }}
          SFTP_PORT: ${{ secrets.TERRARIA_SFTP_PORT }}
          SFTP_USER: ${{ secrets.TERRARIA_SFTP_USER }}
          SFTP_PASS: ${{ secrets.TERRARIA_SFTP_PASS }}
          REMOTE_PATH: ${{ secrets.TERRARIA_WORLD_PATH }}
          DRIVE_REMOTE: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
          KEEP_DAYS: ${{ secrets.KEEP_DAYS }}
        run: |
          set -euo pipefail

          # defaults
          SFTP_PORT="${SFTP_PORT:-2022}"
          KEEP_DAYS="${KEEP_DAYS:-30}"

          if [ -z "$SFTP_HOST" ] || [ -z "$SFTP_USER" ] || [ -z "$DRIVE_REMOTE" ] || [ -z "$SERVER_ID" ]; then
            echo "Missing required secrets"
            exit 1
          fi

          # Remove previous remote
          rclone --config=rclone.conf config delete sftp_tmp >/dev/null 2>&1 || true

          # Create temporary remote
          rclone --config=rclone.conf config create sftp_tmp sftp \
            host "$SFTP_HOST" user "$SFTP_USER" port "$SFTP_PORT" pass "$SFTP_PASS"

          # Connection test
          echo "Testing sftp_tmp..."
          if ! rclone --config=rclone.conf lsf "sftp_tmp:" >/dev/null 2>&1; then
            echo "Connection failed"
            rclone --config=rclone.conf config delete sftp_tmp >/dev/null 2>&1 || true
            exit 1
          fi
          echo "✔️ sftp_tmp reachable"

          # Candidate paths
          CANDIDATES=(
            "${REMOTE_PATH}"
            "saves/Worlds"
            "saves"
            "Worlds"
            "world"
            "/home/container/saves/Worlds"
            "/home/container/saves"
            "/home/container"
            "/home/${SFTP_USER}"
            "/home"
            ""
          )

          FOUND=""
          for p in "${CANDIDATES[@]}"; do
            TARGET="sftp_tmp:${p}"
            MATCHES=$(rclone --config=rclone.conf lsf "$TARGET" --include "*.wld" --include "*.wld.bak" 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
              FOUND="$p"
              break
            fi
          done

          if [ -z "$FOUND" ]; then
            FIRST=$(rclone --config=rclone.conf lsjson "sftp_tmp:" --recursive --files-only 2>/dev/null \
              | jq -r '.[] | select(.Path | test("\\.wld$")) | .Path' | head -n1 || true)
            if [ -n "$FIRST" ]; then
              FOUND="$(dirname "$FIRST")"
            else
              echo "No .wld files found"
              rclone --config=rclone.conf config delete sftp_tmp >/dev/null 2>&1 || true
              echo "files=0" >> "$GITHUB_OUTPUT"
              echo "path=" >> "$GITHUB_OUTPUT"
              exit 1
            fi
          fi

          SELECTED_TARGET="sftp_tmp:${FOUND}"
          SELECTED_PATH="$FOUND"
          FINAL_COUNT=$(rclone --config=rclone.conf lsf "$SELECTED_TARGET" --include "*.wld" --include "*.wld.bak" 2>/dev/null | wc -l)
          echo "files=${FINAL_COUNT}" >> "$GITHUB_OUTPUT"
          echo "path=${SELECTED_PATH}" >> "$GITHUB_OUTPUT"

          # Destinations
          ARCHIVE="${DRIVE_REMOTE}:terraria-backups/${SERVER_ID}/archive/$(date +%F_%H-%M-%S)"
          LATEST="${DRIVE_REMOTE}:terraria-backups/${SERVER_ID}/latest"
          RCLONE_FLAGS="--retries 5 --low-level-retries 10 --timeout 1m --transfers 1 --checkers 8 --progress -v"

          rclone --config=rclone.conf copy "$SELECTED_TARGET" "$ARCHIVE" --include "*.wld" --include "*.wld.bak" --create-empty-src-dirs $RCLONE_FLAGS
          rclone --config=rclone.conf sync "$SELECTED_TARGET" "$LATEST" --include "*.wld" --include "*.wld.bak" --create-empty-src-dirs $RCLONE_FLAGS

          # Prune old backups
          rclone --config=rclone.conf delete "${DRIVE_REMOTE}:terraria-backups/${SERVER_ID}/archive" --min-age ${KEEP_DAYS}d || true
          rclone --config=rclone.conf config delete sftp_tmp >/dev/null 2>&1
          echo "✔️ Upload complete"

  notify:
    needs: backup
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Install utils
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq sed coreutils

      - name: Prepare notification variables
        run: |
          echo "backup_result=${{ needs.backup.result }}" >> $GITHUB_ENV
          echo "files_backed=${{ needs.backup.outputs.files }}" >> $GITHUB_ENV
          echo "selected_path=${{ needs.backup.outputs.path }}" >> $GITHUB_ENV
          echo "server_id=${{ secrets.SERVER_ID }}" >> $GITHUB_ENV

      - name: Send Telegram notification
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "${TG_TOKEN:-}" ] && [ -n "${TG_CHAT:-}" ]; then
            STATUS="${backup_result}"
            FILES="${files_backed:-0}"
            PATH="${selected_path:-unknown}"
            MSG="Terraria backup (${server_id}) — status: ${STATUS}\nfiles: ${FILES}\npath: ${PATH}\nRepo: ${{ github.repository }}\nRun: ${{ github.run_number }}"
            TEXT=$(printf "%s" "$MSG" | sed 's/ /%20/g;s/#/%23/g;s/\\n/%0A/g')
            curl -s "https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT}&text=${TEXT}" >/dev/null || true
            echo "Telegram notified"
          fi

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "${DISCORD_WEBHOOK:-}" ]; then
            STATUS="${backup_result}"
            FILES="${files_backed:-0}"
            PATH="${selected_path:-unknown}"
            JSON="{\"embeds\":[{\"title\":\"Terraria backup: ${server_id}\",\"description\":\"status: ${STATUS}\\nfiles: ${FILES}\\npath: ${PATH}\",\"color\":65280}]}"
            curl -s -H "Content-Type: application/json" -d "$JSON" "${DISCORD_WEBHOOK}" >/dev/null || true
            echo "Discord notified"
          fi
