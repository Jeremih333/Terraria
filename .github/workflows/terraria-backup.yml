name: Terraria world backup (FreeGameHost.xyz)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass jq lftp
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Decode rclone config
        env:
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF }}
        run: |
          set -e
          if [ -z "${RCLONE_CONF_B64:-}" ]; then
            echo "RCLONE_CONF secret missing"
            exit 1
          fi
          echo "$RCLONE_CONF_B64" | base64 -d > rclone.conf
          chmod 600 rclone.conf

      - name: Trigger server save
        env:
          PANEL_URL: ${{ secrets.PANEL_URL }}
          PANEL_API_KEY: ${{ secrets.PANEL_API_KEY }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          if [ -z "${PANEL_URL:-}" ] || [ -z "${PANEL_API_KEY:-}" ] || [ -z "${SERVER_ID:-}" ]; then
            echo "Panel secrets missing"
            exit 1
          fi

          curl -X POST "$PANEL_URL/api/client/servers/$SERVER_ID/command" \
            -H "Authorization: Bearer $PANEL_API_KEY" \
            -H "Accept: application/vnd.pterodactyl.v1+json" \
            -H "Content-Type: application/json" \
            -d '{"command":"save"}' || true

          sleep 10

      - name: Download world via SFTP
        env:
          SFTP_HOST: ${{ secrets.TERRARIA_SFTP_HOST }}
          SFTP_PORT: ${{ secrets.TERRARIA_SFTP_PORT }}
          SFTP_USER: ${{ secrets.TERRARIA_SFTP_USER }}
          SFTP_PASS: ${{ secrets.TERRARIA_SFTP_PASS }}
          REMOTE_WORLD_PATH: ${{ secrets.TERRARIA_WORLD_PATH }}
        run: |
          if [ -z "${SFTP_HOST:-}" ] || [ -z "${SFTP_USER:-}" ] || [ -z "${REMOTE_WORLD_PATH:-}" ]; then
            echo "SFTP secrets missing"
            exit 1
          fi

          mkdir backup
          
          sshpass -p "$SFTP_PASS" lftp -u "$SFTP_USER","$SFTP_PASS" sftp://$SFTP_HOST:${SFTP_PORT:-22} <<EOT
          set sftp:auto-confirm yes
          mirror --include-glob *.wld --include-glob *.wld.bak $REMOTE_WORLD_PATH backup
          bye
EOT

          ls -la backup

          COUNT=$(ls backup/*.wld 2>/dev/null | wc -l)
          if [ "$COUNT" -eq 0 ]; then
            echo "No world files found"
            exit 1
          fi

      - name: Upload to Google Drive
        env:
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          ARCHIVE="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive/$(date +%F_%H-%M-%S)"
          LATEST="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/latest"

          rclone --config=rclone.conf copy backup "$ARCHIVE"
          rclone --config=rclone.conf sync backup "$LATEST"

      - name: Prune old backups
        env:
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          rclone --config=rclone.conf delete "${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive" --min-age 30d || true
