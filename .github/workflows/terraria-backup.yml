name: Terraria world backup (FreeGameHost.xyz)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass jq
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Decode rclone config
        env:
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF }}
        run: |
          set -euo pipefail
          echo "$RCLONE_CONF_B64" | base64 -d > "$GITHUB_WORKSPACE/rclone.conf"
          chmod 600 "$GITHUB_WORKSPACE/rclone.conf"
          echo "✔️ rclone.conf ready"

      - name: (Optional) Trigger server save
        env:
          PANEL_URL: ${{ secrets.PANEL_URL }}
          PANEL_API_KEY: ${{ secrets.PANEL_API_KEY }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
          SKIP_SAVE: ${{ secrets.SKIP_SAVE }}
        run: |
          set -euo pipefail || true
          if [ "${SKIP_SAVE:-}" = "true" ]; then
            echo "Skipping server save"
          else
            if [ -n "${PANEL_URL:-}" ] && [ -n "${PANEL_API_KEY:-}" ] && [ -n "${SERVER_ID:-}" ]; then
              curl -s -X POST "$PANEL_URL/api/client/servers/$SERVER_ID/command" \
                -H "Authorization: Bearer $PANEL_API_KEY" \
                -H "Accept: application/vnd.pterodactyl.v1+json" \
                -H "Content-Type: application/json" \
                -d '{"command":"save"}' || true
              echo "Save command issued"
            else
              echo "Panel API missing, skipping save"
            fi
          fi

      - name: SFTP backup: copy world files via rclone
        env:
          SFTP_HOST: ${{ secrets.TERRARIA_SFTP_HOST }}
          SFTP_PORT: ${{ secrets.TERRARIA_SFTP_PORT }}
          SFTP_USER: ${{ secrets.TERRARIA_SFTP_USER }}
          SFTP_PASS: ${{ secrets.TERRARIA_SFTP_PASS }}
          REMOTE_WORLD_PATH: ${{ secrets.TERRARIA_WORLD_PATH }}
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -euo pipefail

          # build a temporary rclone remote for SFTP
          printf "\n" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "[sftp_tmp]\n" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "type = sftp\n" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "host = %s\n" "$SFTP_HOST" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "user = %s\n" "$SFTP_USER" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "port = %s\n" "${SFTP_PORT:-22}" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "pass = %s\n" "$SFTP_PASS" >> "$GITHUB_WORKSPACE/rclone.conf"

          echo "Listing world folder: $REMOTE_WORLD_PATH"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsf "sftp_tmp:${REMOTE_WORLD_PATH}"

          ARCHIVE="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive/$(date +%F_%H-%M-%S)"
          LATEST="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/latest"

          echo "Uploading to archive: $ARCHIVE"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" copy "sftp_tmp:${REMOTE_WORLD_PATH}" "$ARCHIVE" \
            --include "*.wld" --include "*.wld.bak" --create-empty-src-dirs --transfers=4 --checkers=8 --progress

          echo "Syncing latest -> $LATEST"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" sync "sftp_tmp:${REMOTE_WORLD_PATH}" "$LATEST" \
            --include "*.wld" --include "*.wld.bak" --create-empty-src-dirs

      - name: Prune old backups
        env:
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -e || true
          KEEP_DAYS=30
          ARCHIVE_DIR="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" delete "$ARCHIVE_DIR" --min-age ${KEEP_DAYS}d || true
          echo "✔️ Pruned old backups"          SKIP_SAVE: ${{ secrets.SKIP_SAVE }}
        run: |
          set -euo pipefail
          if [ "${SKIP_SAVE:-}" = "true" ]; then
            echo "SKIP_SAVE=true → skipping server save"
          elif [ -n "${PANEL_URL:-}" ] && [ -n "${PANEL_API_KEY:-}" ] && [ -n "${SERVER_ID:-}" ]; then
            echo "Issuing save command to panel..."
            curl -s -X POST "$PANEL_URL/api/client/servers/$SERVER_ID/command" \
              -H "Authorization: Bearer $PANEL_API_KEY" \
              -H "Accept: application/vnd.pterodactyl.v1+json" \
              -H "Content-Type: application/json" \
              -d '{"command":"save"}' || true
            echo "Save command issued (if supported by panel)"
            sleep 8
          else
            echo "Panel API not configured → skipping save"
          fi

      - name: SFTP backup: copy world files via rclone
        env:
          SFTP_HOST: ${{ secrets.TERRARIA_SFTP_HOST }}
          SFTP_PORT: ${{ secrets.TERRARIA_SFTP_PORT }}
          SFTP_USER: ${{ secrets.TERRARIA_SFTP_USER }}
          SFTP_PASS: ${{ secrets.TERRARIA_SFTP_PASS }}
          REMOTE_WORLD_PATH: ${{ secrets.TERRARIA_WORLD_PATH }}
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -euo pipefail

          # validate required values
          if [ -z "${SFTP_HOST:-}" ] || [ -z "${SFTP_USER:-}" ]; then
            echo "❌ SFTP_HOST and SFTP_USER are required"
            exit 1
          fi
          if [ -z "${RCLONE_REMOTE_NAME:-}" ] || [ -z "${SERVER_ID:-}" ]; then
            echo "❌ RCLONE_REMOTE_NAME and SERVER_ID are required"
            exit 1
          fi
          if [ -z "${REMOTE_WORLD_PATH:-}" ]; then
            echo "❌ TERRARIA_WORLD_PATH is empty — set it to e.g. 'saves/Worlds'"
            exit 1
          fi

          # append temporary sftp remote to rclone.conf
          printf "\n" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "[sftp_tmp]\n" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "type = sftp\n" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "host = %s\n" "$SFTP_HOST" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "user = %s\n" "$SFTP_USER" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "port = %s\n" "${SFTP_PORT:-22}" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "pass = %s\n" "$SFTP_PASS" >> "$GITHUB_WORKSPACE/rclone.conf"

          echo "DEBUG: list remote folder contents at sftp_tmp:${REMOTE_WORLD_PATH}"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsf "sftp_tmp:${REMOTE_WORLD_PATH}" || true

          ARCHIVE="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive/$(date +%F_%H-%M-%S)"
          LATEST="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/latest"

          echo "Uploading world files to archive: $ARCHIVE"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" copy "sftp_tmp:${REMOTE_WORLD_PATH}" "$ARCHIVE" \
            --include "*.wld" --include "*.wld.bak" --create-empty-src-dirs --transfers=4 --checkers=8 --progress

          echo "Syncing latest -> $LATEST"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" sync "sftp_tmp:${REMOTE_WORLD_PATH}" "$LATEST" \
            --include "*.wld" --include "*.wld.bak" --create-empty-src-dirs --progress

      - name: Prune old backups (optional)
        env:
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -e || true
          KEEP_DAYS=30
          ARCHIVE_DIR="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive"
          echo "Pruning backups older than $KEEP_DAYS days in $ARCHIVE_DIR"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" delete "$ARCHIVE_DIR" --min-age ${KEEP_DAYS}d || true
          echo "✔️ Pruned old backups"
