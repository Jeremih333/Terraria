name: Terraria world backup (FreeGameHost.xyz)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    outputs:
      files: ${{ steps.run_backup.outputs.files }}
      path: ${{ steps.run_backup.outputs.path }}

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl coreutils
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Decode rclone config
        env:
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF }}
        run: |
          set -e
          echo "$RCLONE_CONF_B64" | base64 -d > rclone.conf
          chmod 600 rclone.conf

      - name: Run backup
        id: run_backup
        env:
          SFTP_HOST: ${{ secrets.TERRARIA_SFTP_HOST }}
          SFTP_PORT: ${{ secrets.TERRARIA_SFTP_PORT }}
          SFTP_USER: ${{ secrets.TERRARIA_SFTP_USER }}
          SFTP_PASS: ${{ secrets.TERRARIA_SFTP_PASS }}
          REMOTE_PATH: ${{ secrets.TERRARIA_WORLD_PATH }}
          DRIVE_REMOTE: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
          KEEP_DAYS: ${{ secrets.KEEP_DAYS }}
        run: |
          set -euo pipefail

          SFTP_PORT="${SFTP_PORT:-2022}"
          KEEP_DAYS="${KEEP_DAYS:-30}"

          rclone --config=rclone.conf config delete sftp_tmp >/dev/null 2>&1 || true

          rclone --config=rclone.conf config create sftp_tmp sftp \
            host "$SFTP_HOST" user "$SFTP_USER" port "$SFTP_PORT" pass "$SFTP_PASS"

          rclone --config=rclone.conf lsf "sftp_tmp:" >/dev/null

          TARGET="sftp_tmp:${REMOTE_PATH}"
          COUNT=$(rclone --config=rclone.conf lsf "$TARGET" --include "*.wld" --include "*.wld.bak" 2>/dev/null | wc -l || true)
          COUNT="${COUNT:-0}"

          echo "files=${COUNT}" >> "$GITHUB_OUTPUT"
          echo "path=${REMOTE_PATH}" >> "$GITHUB_OUTPUT"

          ARCHIVE="${DRIVE_REMOTE}:terraria-backups/${SERVER_ID}/archive/$(date +%F_%H-%M-%S)"
          LATEST="${DRIVE_REMOTE}:terraria-backups/${SERVER_ID}/latest"

          rclone --config=rclone.conf copy "$TARGET" "$ARCHIVE" --include "*.wld" --include "*.wld.bak"
          rclone --config=rclone.conf sync "$TARGET" "$LATEST" --include "*.wld" --include "*.wld.bak"

          rclone --config=rclone.conf delete "${DRIVE_REMOTE}:terraria-backups/${SERVER_ID}/archive" --min-age ${KEEP_DAYS}d || true

          rclone --config=rclone.conf config delete sftp_tmp >/dev/null 2>&1 || true

  notify:
    needs: backup
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Install curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl

      - name: Send Telegram notification
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
          RESULT: ${{ needs.backup.result }}
          FILES: ${{ needs.backup.outputs.files }}
          PATH: ${{ needs.backup.outputs.path }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          if [ -n "${TG_TOKEN:-}" ] && [ -n "${TG_CHAT:-}" ]; then
            TEXT="Terraria backup ${SERVER_ID} status: ${RESULT} files: ${FILES} path: ${PATH}"
            curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
              -d "chat_id=${TG_CHAT}" \
              -d "text=${TEXT}" \
              || true
          fi
