name: Terraria world backup (SFTP -> rclone cloud)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch: {}

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass jq
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Decode rclone config
        env:
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF }}
        run: |
          if [ -z "${{ secrets.RCLONE_CONF }}" ]; then
            echo "RCLONE_CONF secret is missing. Aborting."
            exit 1
          fi
          echo "${{ secrets.RCLONE_CONF }}" | base64 -d > rclone.conf
          chmod 600 rclone.conf
          echo "rclone config written."

      - name: Trigger server save (send 'save' command)
        env:
          PANEL_URL: ${{ secrets.PANEL_URL }}
          PANEL_API_KEY: ${{ secrets.PANEL_API_KEY }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          if [ -z "$PANEL_URL" ] || [ -z "$PANEL_API_KEY" ] || [ -z "$SERVER_ID" ]; then
            echo "PANEL_URL / PANEL_API_KEY / SERVER_ID must be set as repository secrets"
            exit 1
          fi
          echo "Sending save command to server..."
          curl -s -X POST "$PANEL_URL/api/client/servers/$SERVER_ID/command" \
            -H "Authorization: Bearer $PANEL_API_KEY" \
            -H "Accept: application/vnd.pterodactyl.v1+json" \
            -H "Content-Type: application/json" \
            -d '{"command":"save"}' || true
          sleep 8

      - name: Download world files via SFTP
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASS: ${{ secrets.SFTP_PASS }}
          REMOTE_WORLD_PATH: ${{ secrets.REMOTE_WORLD_PATH }}
        run: |
          if [ -z "$SFTP_HOST" ] || [ -z "$SFTP_USER" ] || [ -z "$REMOTE_WORLD_PATH" ]; then
            echo "SFTP_HOST / SFTP_USER / REMOTE_WORLD_PATH required"
            exit 1
          fi
          WORKDIR="$(pwd)/world_backup_$(date +%s)"
          mkdir -p "$WORKDIR"
          echo "Downloading world files into $WORKDIR"
          if [ -n "$SFTP_PASS" ]; then
            sshpass -p "$SFTP_PASS" sftp -oBatchMode=no -oStrictHostKeyChecking=no -P ${SFTP_PORT:-22} ${SFTP_USER}@${SFTP_HOST} <<EOF
lcd $WORKDIR
cd $REMOTE_WORLD_PATH
mget *.wld *.wld.bak || true
bye
EOF
          else
            # If using private key auth, the repo must contain the PEM private key secret and this branch must be adapted.
            echo "No SFTP password provided; this workflow currently expects SFTP password auth."
            exit 1
          fi
          ls -la "$WORKDIR"

      - name: Upload to cloud with rclone
        env:
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
        run: |
          if [ -z "$RCLONE_REMOTE_NAME" ]; then
            echo "RCLONE_REMOTE_NAME secret is required (name of remote in rclone.conf)."
            exit 1
          fi
          WORKDIR=$(ls -td world_backup_* | head -n1)
          TARGET="${RCLONE_REMOTE_NAME}:terraria-backups/${{ secrets.SERVER_ID }}/$(date +%F_%H-%M-%S)"
          echo "Uploading $WORKDIR -> $TARGET"
          rclone --config=rclone.conf copy "$WORKDIR" "$TARGET" --create-empty-src-dirs --transfers=4 --checkers=8 --no-traverse
          echo "Upload finished."

      - name: Prune old backups (optional)
        env:
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
        run: |
          KEEP_DAYS=30
          echo "Deleting backups older than $KEEP_DAYS days"
          rclone --config=rclone.conf delete ${RCLONE_REMOTE_NAME}:terraria-backups/${{ secrets.SERVER_ID }} --min-age ${KEEP_DAYS}d || true
