name: Terraria world backup (FreeGameHost.xyz)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass jq
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Decode rclone config
        env:
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF }}
        run: |
          set -euo pipefail
          if [ -z "${RCLONE_CONF_B64:-}" ]; then
            echo "❌ RCLONE_CONF secret missing"
            exit 1
          fi
          echo "$RCLONE_CONF_B64" | base64 -d > "$GITHUB_WORKSPACE/rclone.conf"
          chmod 600 "$GITHUB_WORKSPACE/rclone.conf"
          echo "✔️ rclone.conf written to $GITHUB_WORKSPACE/rclone.conf"

      - name: Trigger server save (optional; won't fail job)
        env:
          PANEL_URL: ${{ secrets.PANEL_URL }}
          PANEL_API_KEY: ${{ secrets.PANEL_API_KEY }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
          SKIP_SAVE: ${{ secrets.SKIP_SAVE }}
        run: |
          set -euo pipefail || true
          if [ "${SKIP_SAVE:-}" = "true" ]; then
            echo "SKIP_SAVE=true → skipping panel save"
          elif [ -z "${PANEL_URL:-}" ] || [ -z "${PANEL_API_KEY:-}" ] || [ -z "${SERVER_ID:-}" ]; then
            echo "Panel secrets not fully set → skipping save"
          else
            echo "Calling: $PANEL_URL/api/client/servers/$SERVER_ID/command"
            HTTP_CODE=$(curl -s -o panel_response.json -w "%{http_code}" \
              -X POST "$PANEL_URL/api/client/servers/$SERVER_ID/command" \
              -H "Authorization: Bearer $PANEL_API_KEY" \
              -H "Accept: application/vnd.pterodactyl.v1+json" \
              -H "Content-Type: application/json" \
              -d '{"command":"save"}' || true)
            echo "HTTP code: $HTTP_CODE"
            echo "Panel response:"
            cat panel_response.json || true
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
              echo "Save command accepted"
            else
              echo "Save returned $HTTP_CODE — continuing to SFTP copy"
            fi
            sleep 8
          fi

      - name: Direct copy SFTP -> Google Drive via rclone
        env:
          SFTP_HOST: ${{ secrets.TERRARIA_SFTP_HOST }}
          SFTP_PORT: ${{ secrets.TERRARIA_SFTP_PORT }}
          SFTP_USER: ${{ secrets.TERRARIA_SFTP_USER }}
          SFTP_PASS: ${{ secrets.TERRARIA_SFTP_PASS }}
          REMOTE_WORLD_PATH: ${{ secrets.TERRARIA_WORLD_PATH }}
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -euo pipefail

          # basic checks
          if [ -z "${SFTP_HOST:-}" ] || [ -z "${SFTP_USER:-}" ] || [ -z "${REMOTE_WORLD_PATH:-}" ]; then
            echo "❌ SFTP_HOST / SFTP_USER / REMOTE_WORLD_PATH are required"
            exit 1
          fi
          if [ -z "${RCLONE_REMOTE_NAME:-}" ] || [ -z "${SERVER_ID:-}" ]; then
            echo "❌ RCLONE_REMOTE_NAME and SERVER_ID are required"
            exit 1
          fi

          echo "Appending temporary sftp remote (sftp_tmp) to rclone.conf"
          # ensure newline
          printf "\n" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "[sftp_tmp]\n" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "type = sftp\n" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "host = %s\n" "$SFTP_HOST" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "user = %s\n" "$SFTP_USER" >> "$GITHUB_WORKSPACE/rclone.conf"
          printf "port = %s\n" "${SFTP_PORT:-22}" >> "$GITHUB_WORKSPACE/rclone.conf"
          # pass can contain special chars; print as-is
          printf "pass = %s\n" "$SFTP_PASS" >> "$GITHUB_WORKSPACE/rclone.conf"

          echo "Checking remote path contents (sftp_tmp:${REMOTE_WORLD_PATH})"
          echo "---- rclone lsf (names) ----"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsf "sftp_tmp:${REMOTE_WORLD_PATH}" --include "*.wld" --include "*.wld.bak" || true
          echo "---- rclone ls (detailed sizes) ----"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" ls "sftp_tmp:${REMOTE_WORLD_PATH}" --include "*.wld" --include "*.wld.bak" || true

          # count found .wld
          COUNT=$(rclone --config="$GITHUB_WORKSPACE/rclone.conf" lsf "sftp_tmp:${REMOTE_WORLD_PATH}" --include "*.wld" --include "*.wld.bak" 2>/dev/null | sed '/^\s*$/d' | wc -l || true)
          echo "Found $COUNT matching files on remote"

          if [ "${COUNT:-0}" -eq 0 ]; then
            echo "⚠️ No .wld files found on remote path. Please verify TERRARIA_WORLD_PATH and SFTP credentials."
            exit 1
          fi

          ARCHIVE="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive/$(date +%F_%H-%M-%S)"
          LATEST="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/latest"

          echo "Copying .wld/.wld.bak from sftp_tmp:${REMOTE_WORLD_PATH} -> $ARCHIVE"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" copy "sftp_tmp:${REMOTE_WORLD_PATH}" "$ARCHIVE" --include "*.wld" --include "*.wld.bak" --create-empty-src-dirs --transfers=4 --checkers=8 --progress

          echo "Syncing latest -> $LATEST"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" sync "sftp_tmp:${REMOTE_WORLD_PATH}" "$LATEST" --include "*.wld" --include "*.wld.bak" --create-empty-src-dirs --progress

      - name: Prune old backups (optional)
        env:
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -e || true
          KEEP_DAYS=30
          ARCHIVE_DIR="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive"
          echo "Pruning backups older than $KEEP_DAYS days in $ARCHIVE_DIR"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" delete "$ARCHIVE_DIR" --min-age ${KEEP_DAYS}d || true
          echo "Prune done"          SKIP_SAVE: ${{ secrets.SKIP_SAVE }}
        run: |
          set -euo pipefail || true
          if [ "${SKIP_SAVE:-}" = "true" ]; then
            echo "SKIP_SAVE=true → skipping panel save"
          elif [ -z "${PANEL_URL:-}" ] || [ -z "${PANEL_API_KEY:-}" ] || [ -z "${SERVER_ID:-}" ]; then
            echo "Panel secrets not fully set → skipping save"
          else
            echo "Calling: $PANEL_URL/api/client/servers/$SERVER_ID/command"
            HTTP_CODE=$(curl -s -o panel_response.json -w "%{http_code}" \
              -X POST "$PANEL_URL/api/client/servers/$SERVER_ID/command" \
              -H "Authorization: Bearer $PANEL_API_KEY" \
              -H "Accept: application/vnd.pterodactyl.v1+json" \
              -H "Content-Type: application/json" \
              -d '{"command":"save"}' || true)
            echo "HTTP code: $HTTP_CODE"
            echo "Panel response:"
            cat panel_response.json || true
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
              echo "Save command accepted"
            else
              echo "Save returned $HTTP_CODE — continuing to SFTP download"
            fi
            sleep 8
          fi

      - name: Download world via SFTP (mirror .wld)
        env:
          SFTP_HOST: ${{ secrets.TERRARIA_SFTP_HOST }}
          SFTP_PORT: ${{ secrets.TERRARIA_SFTP_PORT }}
          SFTP_USER: ${{ secrets.TERRARIA_SFTP_USER }}
          SFTP_PASS: ${{ secrets.TERRARIA_SFTP_PASS }}
          REMOTE_WORLD_PATH: ${{ secrets.TERRARIA_WORLD_PATH }}
        run: |
          set -euo pipefail
          if [ -z "${SFTP_HOST:-}" ] || [ -z "${SFTP_USER:-}" ] || [ -z "${REMOTE_WORLD_PATH:-}" ]; then
            echo "❌ SFTP_HOST / SFTP_USER / REMOTE_WORLD_PATH are required"
            exit 1
          fi

          WORKDIR="$GITHUB_WORKSPACE/world_backup_$(date +%s)"
          mkdir -p "$WORKDIR"
          echo "Downloading remote folder: $REMOTE_WORLD_PATH -> $WORKDIR"

          # Use lftp mirror (one-liner) to avoid heredoc/indent problems
          lftp -u "$SFTP_USER","$SFTP_PASS" sftp://$SFTP_HOST:${SFTP_PORT:-22} -e "set sftp:auto-confirm yes; mirror --verbose --only-newer --include-glob *.wld --include-glob *.wld.bak '$REMOTE_WORLD_PATH' '$WORKDIR'; bye" || true

          echo "==== ls of downloaded folder ===="
          ls -la "$WORKDIR" || true

          echo "==== file details ===="
          for f in "$WORKDIR"/*; do
            [ -e "$f" ] && stat "$f" || true
          done

          COUNT=$(ls "$WORKDIR"/*.wld 2>/dev/null | wc -l || true)
          echo "Found $COUNT .wld file(s) in $WORKDIR"

          if [ "${COUNT:-0}" -eq 0 ]; then
            echo "⚠️ No .wld files downloaded — check TERRARIA_WORLD_PATH and SFTP credentials"
            # fail so we don't upload empty backup (optional: change to exit 0 to continue)
            exit 1
          fi

      - name: Upload to Google Drive (archive + latest)
        env:
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -euo pipefail
          if [ -z "${RCLONE_REMOTE_NAME:-}" ]; then
            echo "❌ RCLONE_REMOTE_NAME secret is required"
            exit 1
          fi

          WORKDIR=$(ls -td "$GITHUB_WORKSPACE"/world_backup_* 2>/dev/null | head -n1 || true)
          if [ -z "$WORKDIR" ]; then
            echo "❌ Could not find world backup folder"
            exit 1
          fi

          ARCHIVE="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive/$(date +%F_%H-%M-%S)"
          LATEST="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/latest"

          echo "Uploading $WORKDIR -> $ARCHIVE"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" copy "$WORKDIR" "$ARCHIVE" --create-empty-src-dirs --transfers=4 --checkers=8 --progress

          echo "Syncing to latest -> $LATEST"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" sync "$WORKDIR" "$LATEST" --create-empty-src-dirs --progress

      - name: Prune old backups (optional)
        env:
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -e || true
          KEEP_DAYS=30
          ARCHIVE_DIR="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive"
          echo "Pruning backups older than $KEEP_DAYS days in $ARCHIVE_DIR"
          rclone --config="$GITHUB_WORKSPACE/rclone.conf" delete "$ARCHIVE_DIR" --min-age ${KEEP_DAYS}d || true
          echo "Prune done"          set -e
          if [ -z "${PANEL_URL:-}" ] || [ -z "${PANEL_API_KEY:-}" ] || [ -z "${SERVER_ID:-}" ]; then
            echo "Panel secrets missing"
            exit 1
          fi

          curl -s -X POST "$PANEL_URL/api/client/servers/$SERVER_ID/command" \
            -H "Authorization: Bearer $PANEL_API_KEY" \
            -H "Accept: application/vnd.pterodactyl.v1+json" \
            -H "Content-Type: application/json" \
            -d '{"command":"save"}' || true

          sleep 10

      - name: Download world via SFTP
        env:
          SFTP_HOST: ${{ secrets.TERRARIA_SFTP_HOST }}
          SFTP_PORT: ${{ secrets.TERRARIA_SFTP_PORT }}
          SFTP_USER: ${{ secrets.TERRARIA_SFTP_USER }}
          SFTP_PASS: ${{ secrets.TERRARIA_SFTP_PASS }}
          REMOTE_WORLD_PATH: ${{ secrets.TERRARIA_WORLD_PATH }}
        run: |
          set -e
          if [ -z "${SFTP_HOST:-}" ] || [ -z "${SFTP_USER:-}" ] || [ -z "${REMOTE_WORLD_PATH:-}" ]; then
            echo "SFTP secrets missing"
            exit 1
          fi

          # create local folder for this run
          WORKDIR="$GITHUB_WORKSPACE/world_backup_$(date +%s)"
          mkdir -p "$WORKDIR"
          echo "Downloading from sftp://$SFTP_HOST:${SFTP_PORT:-22}${REMOTE_WORLD_PATH} -> $WORKDIR"

          # Use lftp with -e to run commands (avoids heredoc indentation issues)
          # mirror will copy matching files from remote dir to local WORKDIR
          lftp -u "$SFTP_USER","$SFTP_PASS" sftp://$SFTP_HOST:${SFTP_PORT:-22} -e "set sftp:auto-confirm yes; mirror --verbose --only-newer --include-glob *.wld --include-glob *.wld.bak '$REMOTE_WORLD_PATH' '$WORKDIR'; bye"

          echo "Files downloaded:"
          ls -la "$WORKDIR" || true

          COUNT=$(ls "$WORKDIR"/*.wld 2>/dev/null | wc -l || true)
          if [ "${COUNT:-0}" -eq 0 ]; then
            echo "No .wld files found in $WORKDIR — aborting"
            exit 1
          else
            echo "Found $COUNT .wld file(s)"
          fi

      - name: Upload to Google Drive
        env:
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -e
          if [ -z "${RCLONE_REMOTE_NAME:-}" ] || [ -z "${SERVER_ID:-}" ]; then
            echo "RCLONE_REMOTE_NAME or SERVER_ID missing"
            exit 1
          fi

          WORKDIR=$(ls -td "$GITHUB_WORKSPACE"/world_backup_* 2>/dev/null | head -n1 || true)
          if [ -z "$WORKDIR" ]; then
            echo "Could not find backup folder"
            exit 1
          fi

          ARCHIVE="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive/$(date +%F_%H-%M-%S)"
          LATEST="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/latest"

          echo "Uploading $WORKDIR -> $ARCHIVE"
          rclone --config=rclone.conf copy "$WORKDIR" "$ARCHIVE" --create-empty-src-dirs --transfers=4 --checkers=8

          echo "Syncing to latest -> $LATEST"
          rclone --config=rclone.conf sync "$WORKDIR" "$LATEST" --create-empty-src-dirs

      - name: Prune old backups
        env:
          RCLONE_REMOTE_NAME: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -e || true
          # keep 30 days by default
          KEEP_DAYS=30
          ARCHIVE_DIR="${RCLONE_REMOTE_NAME}:terraria-backups/${SERVER_ID}/archive"
          echo "Deleting backups older than $KEEP_DAYS days in $ARCHIVE_DIR"
          rclone --config=rclone.conf delete "$ARCHIVE_DIR" --min-age ${KEEP_DAYS}d || true
          echo "Prune done"
