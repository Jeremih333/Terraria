name: Terraria world backup (FreeGameHost.xyz)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Decode rclone config
        env:
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF }}
        run: |
          set -e
          if [ -z "${RCLONE_CONF_B64}" ]; then
            echo "RCLONE_CONF secret missing"
            exit 1
          fi
          echo "$RCLONE_CONF_B64" | base64 -d > rclone.conf
          chmod 600 rclone.conf
          echo "rclone.conf ready"

      - name: Create temporary SFTP remote
        env:
          SFTP_HOST: ${{ secrets.TERRARIA_SFTP_HOST }}
          SFTP_PORT: ${{ secrets.TERRARIA_SFTP_PORT }}
          SFTP_USER: ${{ secrets.TERRARIA_SFTP_USER }}
          SFTP_PASS: ${{ secrets.TERRARIA_SFTP_PASS }}
        run: |
          set -e

          if [ -z "$SFTP_HOST" ] || [ -z "$SFTP_USER" ] || [ -z "$SFTP_PASS" ]; then
            echo "SFTP secrets missing"
            exit 1
          fi

          rclone --config=rclone.conf config delete sftp_tmp || true

          rclone --config=rclone.conf config create sftp_tmp sftp \
            host "$SFTP_HOST" \
            user "$SFTP_USER" \
            port "${SFTP_PORT:-22}" \
            pass "$SFTP_PASS"

          echo "SFTP remote created"

      - name: Copy world files to Google Drive
        env:
          REMOTE_PATH: ${{ secrets.TERRARIA_WORLD_PATH }}
          DRIVE_REMOTE: ${{ secrets.RCLONE_REMOTE_NAME }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
        run: |
          set -e

          if [ -z "$REMOTE_PATH" ] || [ -z "$DRIVE_REMOTE" ] || [ -z "$SERVER_ID" ]; then
            echo "Required secrets missing"
            exit 1
          fi

          ARCHIVE_PATH="${DRIVE_REMOTE}:terraria-backups/${SERVER_ID}/archive/$(date +%F_%H-%M-%S)"
          LATEST_PATH="${DRIVE_REMOTE}:terraria-backups/${SERVER_ID}/latest"

          echo "Copying archive..."
          rclone --config=rclone.conf copy "sftp_tmp:${REMOTE_PATH}" "$ARCHIVE_PATH" \
            --include "*.wld" \
            --include "*.wld.bak" \
            --create-empty-src-dirs

          echo "Syncing latest..."
          rclone --config=rclone.conf sync "sftp_tmp:${REMOTE_PATH}" "$LATEST_PATH" \
            --include "*.wld" \
            --include "*.wld.bak"

          echo "Backup complete"

      - name: Cleanup
        run: |
          rclone --config=rclone.conf config delete sftp_tmp || true
          echo "Cleanup done"
